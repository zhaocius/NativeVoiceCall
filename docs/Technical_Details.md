# NativeVoiceCall 技术细节

## 架构概述

NativeVoiceCall 使用UDP协议实现真正的局域网语音通话，具有以下特点：

### 网络架构

1. **UDP协议**: 使用UDP进行实时音频传输，减少延迟
2. **广播通信**: 支持局域网内的广播发现
3. **房间管理**: 服务器管理用户房间和消息转发
4. **P2P通信**: 客户端之间直接通信，减少服务器负载

### 音频处理

1. **ALSA音频**: Linux平台使用ALSA进行音频捕获和播放
2. **实时处理**: 20ms音频帧处理，确保低延迟
3. **音量控制**: 支持麦克风和扬声器音量调节
4. **静音功能**: 支持麦克风静音控制

## 实现细节

### 核心组件

#### 1. UDP客户端 (udp_voice_call.cpp)
- 创建UDP socket
- 处理网络消息
- 管理音频设备
- 实现状态管理

#### 2. UDP服务器 (udp_server.cpp)
- 房间管理
- 用户连接管理
- 消息转发
- 广播处理

#### 3. 音频处理
- ALSA设备初始化
- 音频数据捕获
- 音频数据播放
- 音量控制

### 消息协议

#### 控制消息格式
```
JOIN:room_id:user_id
LEAVE:room_id:user_id
AUDIO:room_id:user_id:audio_data
```

#### 音频包结构
```c
struct AudioPacket {
    uint32_t sequence;      // 序列号
    uint32_t timestamp;     // 时间戳
    uint32_t user_id;       // 用户ID
    uint16_t data_size;     // 数据大小
    uint8_t data[1024];     // 音频数据
};
```

### 网络流程

1. **连接建立**
   - 客户端创建UDP socket
   - 发送JOIN消息到服务器
   - 服务器记录用户信息
   - 广播用户加入消息

2. **音频传输**
   - 客户端捕获音频数据
   - 打包成AudioPacket
   - 发送到服务器
   - 服务器转发给房间内其他用户

3. **连接断开**
   - 客户端发送LEAVE消息
   - 服务器清理用户信息
   - 广播用户离开消息

## 性能优化

### 网络优化
- UDP协议减少延迟
- 音频数据压缩
- 序列号检测丢包
- 时间戳同步

### 音频优化
- 20ms音频帧
- 48kHz采样率
- 16位音频格式
- 单声道传输

### 系统优化
- 多线程处理
- 非阻塞I/O
- 内存池管理
- 零拷贝传输

## 安全考虑

### 网络安全
- 局域网隔离
- 消息验证
- 用户认证
- 数据加密（可选）

### 音频安全
- 音频设备权限
- 音量限制
- 噪声过滤
- 回声消除

## 扩展性

### 功能扩展
- 视频通话
- 群组通话
- 文件传输
- 屏幕共享

### 平台扩展
- Windows支持
- iOS支持
- Web支持
- 嵌入式设备

### 协议扩展
- WebRTC集成
- SIP协议支持
- 自定义协议
- 多协议兼容

## 故障排除

### 常见问题

1. **网络连接失败**
   - 检查防火墙设置
   - 确认端口可用
   - 验证IP地址
   - 检查网络配置

2. **音频问题**
   - 检查音频设备
   - 确认ALSA安装
   - 验证权限设置
   - 测试音频设备

3. **编译错误**
   - 检查依赖库
   - 确认编译器版本
   - 验证CMake配置
   - 查看错误日志

### 调试方法

1. **网络调试**
   ```bash
   # 使用netstat查看端口
   netstat -tuln | grep 8080
   
   # 使用tcpdump抓包
   sudo tcpdump -i lo udp port 8080
   ```

2. **音频调试**
   ```bash
   # 测试ALSA
   aplay -l
   arecord -l
   
   # 测试音频设备
   speaker-test -c 2 -t sine
   ```

3. **程序调试**
   ```bash
   # 使用gdb调试
   gdb ./voice_call_client
   
   # 使用strace跟踪系统调用
   strace ./voice_call_client
   ```

## 开发指南

### 添加新功能

1. **定义消息类型**
   - 在消息协议中添加新格式
   - 更新服务器处理逻辑
   - 修改客户端处理代码

2. **扩展音频功能**
   - 添加新的音频处理模块
   - 集成音频编解码器
   - 实现音频效果处理

3. **优化性能**
   - 分析性能瓶颈
   - 优化关键路径
   - 添加性能监控

### 代码规范

1. **C++规范**
   - 使用C++17标准
   - 遵循Google C++风格
   - 添加详细注释
   - 编写单元测试

2. **网络编程**
   - 错误处理
   - 资源管理
   - 线程安全
   - 超时处理

3. **音频编程**
   - 设备管理
   - 数据格式
   - 缓冲区管理
   - 实时处理

